# MMPEA 记忆管理 v5


**作者**: 金瓜瓜
**版本**: 5.4.0
**平台**: SillyTavern 1.13.0 第三方扩展

---

## 这是什么？

聊天机器人有个老毛病：聊久了就忘事。上周你告诉它你怕蜘蛛，今天它就让你去蜘蛛展。

MMPEA 就是给 AI 装的"记忆本"。它在后台默默工作：

1. **自动记笔记** — 每隔几条消息，把重要的事记下来（谁做了什么、承诺了什么、关系怎么变了）
2. **聊天时翻记忆** — AI 回复前，先翻一翻笔记本，把相关的回忆找出来塞给 AI 看
3. **笔记本不会爆炸** — 旧笔记自动压缩，时间线自动合并，不会越聊越卡

你不需要做任何事，装上就行。想要更好的效果，可以配一个便宜的副API。

---

## 快速上手

### 最简安装（零配置）

1. 把 `memory-manager` 文件夹放到 SillyTavern 的 `data/<用户>/extensions/` 目录下
2. 重启 SillyTavern
3. 打开扩展面板，找到"MMPEA记忆管理"，确认"启用"是勾上的
4. 开始聊天 — 每 5 条消息自动提取一次记忆

这样就能用了。检索方式是关键词匹配，够用但不够聪明。

### 进阶配置（推荐）

配一个**副API**，记忆效果会好很多：

1. 准备一个 OpenAI 兼容的 API（中转站、one-api、new-api 都行）
2. 在设置面板勾选"使用副API"，填入地址、密钥、模型名
3. 点"测试连接"确认能通
4. （可选）勾选"启用 Embedding 语义检索"，填入 Embedding 模型名

副API的好处：
- 记忆提取和检索走副API，**不消耗你的主API额度**
- 检索从"关键词匹配"升级为"AI 阅读记忆后写回忆叙事"
- 便宜的小模型就够用（DeepSeek 等）

---

## 它在背后做了什么？

### 一句话版本

```
你们聊天 → 后台 AI 记笔记 → 下次聊天前翻笔记 → 把相关回忆塞给 AI
```

### 详细版本

MMPEA 维护一个"记忆本"，里面有四样东西：

| 记忆本的内容 | 说明 | 例子 |
|-------------|------|------|
| **时间线** | 故事大纲，一天一条 | "D5: 薇尔莉特在学校暴露了康纳的身份" |
| **角色档案** | NPC 的外貌、性格、态度 | "塞纳·42岁·退伍军人·对康纳戒备但逐渐接受" |
| **故事页** | 具体事件的详细记录 | "D3-写作业交易: 薇尔莉特用化妆品遮住LED灯环，提议交易——帮写数学作业换身份和住所" |
| **物品** | 重要物品 | "LED灯环遮挡粉底液·使用中" |

### 怎么记的？（提取）

每隔 N 条新消息（默认5条），后台 AI 阅读这些消息，输出一份结构化报告：
- 时间线要不要更新？
- 有没有新角色出场？老角色态度变了吗？
- 发生了什么值得记下来的事？→ 写成故事页
- 每个故事页自动打标签：情感、关系、承诺、冲突、转折、日常……

### 怎么翻的？（检索）

你发一条消息，AI 还没回复的那个瞬间：

```
第一步 — 永远在场的"目录"
  时间线 + 角色态度 + 物品列表，永远在 AI 的视野里
  AI 知道"故事里发生过什么"，但看不到细节

第二步 — 翻记忆（三种方式，从上到下逐级尝试）

  方式A: Embedding 语义检索（需要配置）
    把你刚说的话变成一串数字（向量），和记忆本里每条记忆的数字比对
    找出最相关的几页作为"候选"
    ↓
  方式B: 记忆代理（需要副API）
    一个独立的小 AI 阅读候选记忆，像人一样联想：
    "他们在聊身份的事……之前D3有个写作业交易，D5有身份暴露……"
    然后写出一段连贯的回忆叙事，直接塞给主 AI
    ↓
  方式C: 关键词匹配（兜底）
    从你说的话里提取关键词，和故事页的标签比对
    选匹配度最高的几页，把原文塞给主 AI

第三步 — 注入
  把找到的回忆和角色档案塞进 AI 的提示词
  AI 读到这些回忆后，就能写出"记得之前发生过什么"的回复
```

---

## 功能清单

### 记忆存档

记忆默认跟着聊天走。但如果你换了一个新聊天，记忆就没了。

存档系统解决这个问题：
- **自动保存**：每次提取记忆后，自动保存到当前存档
- **多个存档**：同一个角色可以有多个存档（主线、IF线、分支……）
- **跨聊天加载**：换了新聊天，如果这个角色有存档，会弹出提示问你要不要加载
- **手动管理**：在设置面板里可以新建、加载、删除存档

### 故事页编辑

设置面板 → 故事页 → 点击任意故事页上的"编辑"按钮，展开完整编辑表单：
- 标题、天数（如 D1）、日期（如 251017）
- 内容正文
- 关键词（逗号分隔）
- 分类标签（多选，带颜色）
- 重要程度（高/中）

修改后点保存，如果配置了 Embedding 会自动重建向量。

点"+ 新增故事页"可手动创建空白故事页，适合补录被遗漏的重要事件。

### 小电视面板（三个 Tab）

点击右下角的小机器人（小电视），面板分为三个 Tab：

#### Tab 1：召回
展示本次 AI 回复前检索到的记忆叙事原文，以及召回的角色档案。

#### Tab 2：管理指令
给记忆管理员写"工作备注"，告诉它记录和检索时的偏好：
- **全局指令**：每个环节都会附加
- **提取指令**：记笔记时的特别要求（比如"重点记录情感变化"）
- **召回指令**：翻记忆时的特别要求（比如"优先找承诺相关的"）
- **压缩指令**：整理旧笔记时的特别要求（比如"保留所有角色名"）

可以直接保存，也可以点"让管理员整理"让 LLM 帮你重新分配到各字段。

#### Tab 3：工具箱
三个实用工具：

**记忆体检**：找出因删楼产生的"孤立记忆"（消息已删但记忆还在），可选择性删除或只清理日期标记。

**快捷操作**：
- 提取指定范围的消息（起止编号 → 走完整提取流程）
- 把某段消息标记为"已提取"（跳过不需要记忆的对话段）
- 重建向量库快捷入口

**实时指令**：用自然语言直接操控记忆数据。比如"删掉D10到D13之间所有日常类的故事页"，管理员会用工具帮你执行。离开 Tab 或关闭面板自动清空对话记录（省钱）。

### 语义分类标签

每个故事页自动标注1-3个分类，用颜色区分：

| 标签 | 含义 | 颜色 |
|------|------|------|
| 情感 | 哭了、笑了、感动了 | 粉色 |
| 关系 | 关系进展或变化 | 黄色 |
| 亲密 | 亲密互动 | 红色 |
| 承诺 | 说了"我保证"之类的 | 紫色 |
| 冲突 | 吵架、对抗 | 橙色 |
| 发现 | 揭秘、发现真相 | 青色 |
| 转折 | 剧情重大转折 | 绿色 |
| 日常 | 普通日常 | 灰色 |

### 渐进式压缩

记忆不会无限膨胀。有三个独立的压缩开关，你可以自己控制：

| 压缩类型 | 默认 | 做什么 |
|----------|------|--------|
| **时间线压缩** | 开 | 时间线超过20条时，把旧条目合并（"D1-D3: 概括"） |
| **故事页压缩** | 关 | 详细页超过15个时，把最老的压缩成30-50字摘要 |
| **归档日常页** | 关 | 总页数超过50时，删除只有"日常"标签的旧摘要页 |

重要记忆（转折、承诺、冲突等）永远不会被自动删除。

故事页不在上下文里常驻（只在需要时才检索），所以通常不需要压缩它们。时间线压缩建议保持开启，因为时间线始终在 AI 视野中。

### 上下文管理（自动隐藏）

聊了几百条消息后，上下文会很长。开启"保留最近N条消息"后：
- 已经被提取过记忆的旧消息会被隐藏（标记为系统消息）
- 最近 N 条消息保留可见，给 AI 足够的即时上下文
- 隐藏在每次提取完成后执行（提取间隔控制频率）

建议 N=6（最近3轮对话）就够了。更早的内容由记忆系统接管。

### Embedding 向量检索

如果你的 API 支持 `/v1/embeddings` 接口，可以开启这个功能：
- 把每条记忆变成一串数字（向量），存在本地
- 检索时把你说的话也变成数字，和记忆逐条比对
- 找出语义上最相关的（不只是关键词匹配）
- 比如你说"那天好冷"，它能找到"暴风雪中的约定"

默认复用副API的地址和密钥。256维向量，每条记忆约1KB，100条记忆≈100KB。

---

## 设置项速查

### 基础设置

| 设置 | 默认 | 说明 |
|------|------|------|
| 启用 | 开 | 总开关 |
| 调试日志 | 关 | 在浏览器控制台输出详细日志 |
| 提取间隔 | 5 | 每多少条新消息触发一次记忆提取 |
| 提取最大Token | 4096 | 提取时 AI 回复的最大长度 |
| 已知角色 | 空 | 主要角色名（逗号分隔），只跟踪态度不生成详细档案 |

### 检索设置

| 设置 | 默认 | 说明 |
|------|------|------|
| 故事索引深度 | 9999 | 目录注入位置（9999=始终可见） |
| 故事页深度 | 2 | 回忆注入位置（2=靠近最新消息） |
| 最大检索页数 | 3 | 每次最多检索几页故事 |

### 压缩设置

| 设置 | 默认 | 说明 |
|------|------|------|
| 时间线压缩 | 开 | 时间线超过20条自动合并 |
| 故事页压缩 | 关 | 详细页超过15个自动压缩为摘要 |
| 归档日常页 | 关 | 总页数超过50时删除旧日常摘要页 |

### 上下文管理

| 设置 | 默认 | 说明 |
|------|------|------|
| 自动隐藏 | 关 | 隐藏已提取过的旧消息 |
| 保留消息数 | 10 | 保留最近几条消息可见 |

### 副API

| 设置 | 默认 | 说明 |
|------|------|------|
| 使用副API | 关 | 启用后提取和检索走副API |
| API地址 | 空 | OpenAI 兼容地址（如 `https://api.example.com/v1/chat/completions`） |
| API密钥 | 空 | API Key |
| 模型 | 空 | 模型名（如 `deepseek-chat`） |
| 温度 | 0.3 | 越低越稳定 |

### Embedding

| 设置 | 默认 | 说明 |
|------|------|------|
| 启用Embedding | 关 | 开启语义向量检索 |
| 模型 | text-embedding-3-large | Embedding 模型名 |
| 向量维度 | 256 | 越高越精确但占更多空间 |
| 预筛选数量 | 10 | 每次检索多少条候选 |
| API地址 | 空 | 留空则复用副API地址 |
| API密钥 | 空 | 留空则复用副API密钥 |

### 存档

| 设置 | 默认 | 说明 |
|------|------|------|
| 自动保存 | 开 | 每次提取后自动保存到当前存档 |

---

## 斜杠命令

在聊天框输入这些命令可以手动操作：

| 命令 | 做什么 |
|------|--------|
| `/mm-extract` | 立即提取一次记忆（不等间隔） |
| `/mm-recall` | 看看刚才检索到了什么回忆 |
| `/mm-index` | 看看当前的故事目录（时间线+物品） |
| `/mm-pages` | 列出所有故事页 |
| `/mm-compress` | 立即执行一次压缩 |
| `/mm-reset` | 清空当前聊天的所有记忆（谨慎！） |

---

## 常见问题

**Q: 装上之后要做什么？**
A: 什么都不用做。聊天就行，它在后台自动工作。

**Q: 已经聊了很久了，之前的内容能补录吗？**
A: 可以。点设置面板里的"初始化记忆"按钮，它会读取所有历史消息批量提取。

**Q: 副API一定要配吗？**
A: 不是必须的。不配也能用（关键词匹配检索），配了效果更好（AI 联想检索）。

**Q: Embedding 一定要开吗？**
A: 不是必须的。它是锦上添花 — 让检索从"关键词匹配"变成"语义理解"。

**Q: 会不会很费钱？**
A: 提取和检索走的是副API（便宜的小模型就行）。Embedding 更便宜。主API额度不受影响。

**Q: 换了新聊天，记忆全没了？**
A: 如果开了"自动保存存档"，切换聊天时会提示你加载存档。点一下就恢复了。

**Q: 故事页压缩会不会丢掉重要内容？**
A: 故事页压缩和归档默认关闭。即使开启，归档只删"日常"标签的页面，重要记忆（转折、承诺、冲突等）永远不会被自动删除。

**Q: 小电视是什么？**
A: 聊天界面右下角的浮动机器人按钮。点开有三个 Tab：召回（看这次记忆叙事）、管理指令（告诉记忆管理员你的偏好）、工具箱（体检/快捷操作/实时指令）。

**Q: 我删了几条消息，记忆里还有那些内容怎么办？**
A: 打开小电视 → 工具箱 → 记忆体检，它会自动找出与已删消息相关的故事页，你可以选择删除或保留。

**Q: 管理指令是什么？**
A: 你给记忆管理员的工作备注。比如"提取时重点记录情感变化""召回时优先找承诺类记忆"。它会附加到对应的提示词里，影响每次提取/召回/压缩的行为。

---

## 文件结构

| 文件 | 说明 |
|------|------|
| `manifest.json` | 扩展信息 |
| `index.js` | 全部逻辑 |
| `settings.html` | 设置面板 |
| `style.css` | 样式 |
| `README.md` | 本文件 |
| `CHANGELOG.md` | 更新日志 |
| `DEVLOG.md` | 开发日志 |
